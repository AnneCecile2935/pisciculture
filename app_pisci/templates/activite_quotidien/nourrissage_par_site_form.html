{% extends "base.html" %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/button_custom.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <link rel="stylesheet" href="{% static 'css/form_styles.css' %}">
{% endblock %}
{% block title %}Enregistrement des repas pour {{ site.nom }}{% endblock %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">  <!-- Ajuste la largeur selon tes besoins -->
            <div class="card form-container">
                <!-- En-tête avec titre stylisé -->
                <div class="card-header form-title-header bg-gradient-custom">
                    <h3 class="mb-0 d-flex align-items-center text-white">
                        Enregistrement des repas pour le site : {{ site.nom }}
                    </h3>
                </div>
                <!-- Corps du formulaire -->
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
												{% if form.non_form_errors %}
                        <div class="alert alert-danger mb-3">
                            {% for error in form.non_form_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        <!-- Date et notes (style "floating labels" comme dans form.html) -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="date_repas" name="date_repas"
                                           value="{{ today|date:'Y-m-d' }}" required>
                                    <label for="date_repas">Date des repas</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <textarea class="form-control" id="notes" name="notes" rows="2" style="height: 100%;"></textarea>
                                    <label for="notes">Notes</label>
                                </div>
                            </div>
                        </div>
                        <!-- Formset (tableau) -->
                        {{ form.management_form }}
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Bassin</th>
                                        <th>Aliment</th>
                                        <th>Quantité (kg)</th>
                                        <th>Motif d'absence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for subform in form %}
                                    <tr>
                                        <td>
																					{{ subform.initial.bassin.nom }}
																					{{ subform.bassin }}
																					{% if subform.bassin.errors %}
                                              <div class="text-danger">{{ subform.bassin.errors|first }}</div>
                                          {% endif %}
																				</td>
                                        <td>{{ subform.aliment }}</td>

																				{% if subform.aliment.errors %}
                                            <div class="text-danger">{{ subform.aliment.errors|first }}</div>
                                        {% endif %}
																				<td>{{ subform.qte }}</td>
																				{% if subform.qte.errors %}
																						<div class="text-danger">{{ subform.qte.errors|first }}</div>
																				{% endif %}
                                        <td>
                                            {% with bassin=subform.initial.bassin %}
                                                {% if not bassin.lots_poissons.first %}
                                                    {{ subform.motif_absence.as_hidden }}
                                                    <span>vide</span>
                                                    <input type="hidden" name="form-{{ forloop.counter0 }}-motif_absence" value="vide">
                                                {% else %}
                                                    {{ subform.motif_absence }}
																										{% if subform.motif_absence.errors %}
                                                        <div class="text-danger">{{ subform.motif_absence.errors|first }}</div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Boutons alignés à droite -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill">
                                <i class="bi bi-save me-2"></i> Enregistrer les repas
                            </button>
                            <a href="{% url 'activite_quotidien:nourrissage-list' %}"
                               class="btn btn-outline-secondary px-4 py-2 rounded-pill">
                                <i class="bi bi-x-circle me-2"></i> Annuler
                            </a>
                        </div>
                    </form>
                </div>


								</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pour chaque ligne du formset
    document.querySelectorAll('[name$="-motif_absence"]').forEach(function(select) {
        const row = select.closest('tr'); // Trouve la ligne du formset
        const qteInput = row.querySelector('[name$="-qte"]'); // Trouve le champ quantité

        // Fonction pour mettre à jour la quantité
        function updateQte() {
            if (select.value === 'ajeun') {
                qteInput.value = 0;
                qteInput.readOnly = true;
                qteInput.required = false; // Pas obligatoire si "à jeun"
            } else {
                qteInput.readOnly = false;
                qteInput.required = true;
            }
        }

        // Écoute les changements sur le select
        select.addEventListener('change', updateQte);

        // Initialise au chargement de la page
        updateQte();
});

		document.querySelectorAll('.invalid-feedback, .text-danger').forEach(function(errorElement) {
            if (errorElement.textContent.trim() !== '') {
                const input = errorElement.previousElementSibling;
                if (input && input.classList.contains('form-control')) {
                    input.classList.add('is-invalid');
                }
            }

    });
});
</script>
{% endblock %}
