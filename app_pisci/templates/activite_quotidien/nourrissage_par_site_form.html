{% extends "form_templates.html" %}
{% block title %}Saisie des repas pour {{ site.nom }}{% endblock %}
{% block form_title %}Saisie des repas pour {{ site.nom }}{% endblock %}

{% block form_content %}
<div class="alert alert-info">
    Renseignez les repas pour chaque bassin. Les champs "Aliment" sont pré-remplis avec le dernier aliment utilisé.
</div>

<form method="post" id="nourrissage-form">
    {% csrf_token %}

    <div class="mb-3">
        <label class="form-label">Site : {{ site.nom }}</label>
    </div>

    <div class="mb-3">
        <label for="id_date_repas" class="form-label">Date du repas</label>
        <input type="date" name="date_repas" id="id_date_repas" class="form-control"
               value="{{ form.date_repas.value|date:'Y-m-d' }}">
    </div>

    <div class="table-responsive">
        <table class="table table-bordered" id="nourrissage-table">
            <thead class="table-light">
                <tr>
                    <th>Bassin</th>
                    <th>Aliment</th>
                    <th>Quantité (kg)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront générées en JS -->
            </tbody>
        </table>
    </div>

    <div class="mb-3">
        <label for="id_notes" class="form-label">Commentaires</label>
        <textarea name="notes" class="form-control" id="id_notes" rows="3"
                  placeholder="Ajoutez des commentaires si nécessaire..."></textarea>
    </div>

    <button type="submit" class="btn btn-primary">
        <i class="bi bi-save"></i> Enregistrer tous les repas
    </button>
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-x-circle"></i> Annuler
    </a>
</form>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.querySelector('#nourrissage-table tbody');

    // Données passées depuis la vue (nettoyées côté Python)
    const bassins = JSON.parse('{{ bassins_json|escapejs }}');
    const aliments = JSON.parse('{{ aliments_json|escapejs }}');

    // Ajout des lignes dynamiques dans le tableau
    bassins.forEach(bassin => {
        const row = document.createElement('tr');

        // --- Colonne : Nom du bassin
        const bassinCell = document.createElement('td');
        bassinCell.textContent = bassin.nom;
        row.appendChild(bassinCell);

        // --- Colonne : Aliment
        const alimentCell = document.createElement('td');
        const alimentSelect = document.createElement('select');
        alimentSelect.name = `aliment_${bassin.id}`;
        alimentSelect.className = 'form-select';
        alimentSelect.required = true;

        // Ajoute les options d’aliments
        aliments.forEach(aliment => {
            const option = document.createElement('option');
            option.value = aliment.id;
            option.textContent = aliment.nom;
            alimentSelect.appendChild(option);
        });

        // Pré-sélection du dernier aliment (si connu)
        if (bassin.dernier_aliment_id) {
            alimentSelect.value = bassin.dernier_aliment_id;
        }

        alimentCell.appendChild(alimentSelect);
        row.appendChild(alimentCell);

        // --- Colonne : Quantité
        const qteCell = document.createElement('td');
        const qteInput = document.createElement('input');
        qteInput.type = 'number';
        qteInput.name = `qte_${bassin.id}`;
        qteInput.className = 'form-control';
        qteInput.step = '1';
        qteInput.min = '0';
        qteCell.appendChild(qteInput);
        row.appendChild(qteCell);

        // --- Champs cachés : ID du bassin
        const bassinHidden = document.createElement('input');
        bassinHidden.type = 'hidden';
        bassinHidden.name = `bassin_${bassin.id}`;
        bassinHidden.value = bassin.id;
        row.appendChild(bassinHidden);

				if (bassin.lot_id) {
						const lotHidden = document.createElement('input');
						lotHidden.type = 'hidden';
						lotHidden.name = `lot_${bassin.id}`;
						lotHidden.value = bassin.lot_id;
						row.appendChild(lotHidden);
				}

        // Ajoute la ligne au tableau
        tableBody.appendChild(row);
    });
});
</script>
{% endblock %}
